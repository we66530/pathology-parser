<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Breast Pathology → Structured Summary (Local)</title>
  <style>
    :root {--bg:#f7f7fb;--ink:#0f172a;--muted:#6b7280;--card:#ffffff;--primary:#111827;--ring:#3b82f6;}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    .title{font-weight:800;font-size:clamp(20px,3vw,30px);margin:0 0 6px}
    .sub{color:var(--muted);margin:0 0 24px}
    .grid{display:grid;gap:24px;grid-template-columns:1fr} @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(2,8,23,.06)}
    .row{display:flex;gap:12px;align-items:center}
    textarea, input[type="number"]{width:100%;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;font:inherit}
    textarea:focus, input:focus{outline:none;box-shadow:0 0 0 3px rgba(59,130,246,.25)}
    button{border:0;border-radius:12px;cursor:pointer;padding:10px 14px;font-weight:600}
    .btn{background:var(--primary);color:#fff} .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn-ghost{background:#fff;border:1px solid #e5e7eb}
    .hint{font-size:12px;color:var(--muted)}
    .table{width:100%;border-collapse:collapse;font-size:14px}
    .table td{padding:10px 8px;vertical-align:top;border-bottom:1px solid #f0f2f7}
    .key{white-space:nowrap;color:#64748b;width:220px}
    .badge{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3}
    .copied{font-size:12px;color:#16a34a;margin-left:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">Breast Pathology → Structured Summary (Local)</h1>
    <p class="sub">Paste a free‑text pathology report, click <strong>Parse</strong>, then copy the one‑line summary. Everything runs in your browser—no uploads.</p>

    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between;margin-bottom:8px">
          <strong>Input (paste report)</strong>
          <button class="btn-ghost" id="sampleBtn">Use sample</button>
        </div>
        <textarea id="input" rows="16" placeholder="Paste the report text here..."></textarea>
        <div class="row" style="margin-top:12px">
          <button class="btn" id="parseBtn">Parse</button>
          <label class="hint">Ki‑67 threshold for Luminal A/B:&nbsp;
            <input type="number" id="kiThresh" value="20" min="0" max="100" style="width:80px"> %
          </label>
          <span id="err" class="hint" style="color:#dc2626"></span>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;margin-bottom:8px">
          <strong>One‑line summary</strong>
          <div class="row">
            <button class="btn-ghost" id="copyBtn" disabled>Copy</button>
            <span id="copiedMsg" class="copied" style="display:none">Copied!</span>
          </div>
        </div>
        <textarea id="summary" rows="8" readonly style="background:#fafafa"></textarea>
        <p class="hint" style="margin-top:8px">Example: “Right breast invasive carcinoma of no special type, grade 1, ER: positive (90%), PR: positive (95%), HER2: negative (score 0), luminal type A, TxNxMx, Stage —”.</p>
      </div>
    </div>

    <div id="tableWrap" class="card" style="margin-top:24px;display:none">
      <strong style="display:block;margin-bottom:8px">Parsed fields</strong>
      <div style="overflow-x:auto">
        <table class="table" id="parsedTable"></table>
      </div>
      <p class="hint" style="margin-top:8px"><strong>Notes:</strong> Rule‑based demo; verify results. Subtype heuristic: HR+ & HER2– with Ki‑67 &lt; threshold → luminal type A; HR+ & HER2– with Ki‑67 ≥ threshold → luminal type B (HER2–); HR+ & HER2+ → luminal type B (HER2+); HR– & HER2+ → HER2‑enriched; HR– & HER2– → triple‑negative.</p>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function normalizeText(t){
      return (t||"")
        .replace(/\r/g, "\n")
        .replace(/[\u2022\u25CF\u25E6\u2043\u2219\u00B7]/g, "•")
        .replace(/\u00A0/g, " ")
        .replace(/[\t\f\v]+/g, " ")
        .replace(/ +/g, " ")
        .trim();
    }

    function numOrNull(x){
      if(x==null) return null; const v=parseFloat(x); return Number.isFinite(v)?v:null;
    }

    function pickStatus(s){
      if(!s) return undefined; const low=s.toLowerCase();
      if(/pos|陽/.test(low)) return 'positive';
      if(/neg|陰/.test(low)) return 'negative';
      if(/equivocal/.test(low)) return 'equivocal';
      if(/weak/.test(low)) return 'weakly positive';
      return s;
    }

    function parseIHC(block){
      const status = pickStatus((block.match(/\b(positive|negative|equivocal|weak(?:ly)?\s*positive)\b/i)||[])[1]);
      const percent = numOrNull((block.match(/(\d{1,3})\s*%/i)||[])[1]||null);
      const strength = (block.match(/\b(strong|moderate|weak)\b/i)||[])[1]||null;
      const score = (block.match(/(score\s*\d\+?|[0-3]\+)/i)||[])[1]||null;
      return { raw:block, status, percent, strength, score };
    }

    function parseReport(raw){
      const t = normalizeText(raw);
      const side = (t.match(/Breast\s*,\s*(left|right)\b/i)||[])[1]?.toLowerCase() ||
                   (t.match(/\b(left|right)\s+breast\b/i)||[])[1]?.toLowerCase() || null;
      const organ = /breast/i.test(t) ? 'breast' : null;
      const histType = (t.match(/Histologic type\s*:\s*([^\.\n]+)/i)||[])[1]?.trim() ||
                       (t.match(/invasive carcinoma of no special type/i)||[])[0] || null;

      const gm = t.match(/Histologic grade.*?:\s*grade\s*(\d)\s*\(score\s*(\d+)\)/i) ||
                 t.match(/Nottingham histologic score.*?\bgrade\s*(\d).*?\(score\s*(\d+)\)/i);
      const grade = gm ? parseInt(gm[1],10) : null;
      const gradeScore = gm ? parseInt(gm[2],10) : null;

      const sizeMM = numOrNull((t.match(/Tumor size[^:]*:\s*([\d.]+)\s*mm/i)||[])[1]);

      const dcisBlock = (t.match(/Ductal carcinoma in situ\s*:\s*([^\.\n]+)(?:\.|\n|$)/i)||[])[1] || null;
      const dcis = dcisBlock ? {
        present: /(present|identified)/i.test(dcisBlock) ? true : /(absent|not identified|not\s+seen)/i.test(dcisBlock) ? false : null,
        grade: (dcisBlock.match(/nuclear\s*grade\s*(\d)/i)||[])[1] || null,
      } : null;

      const lvi = (t.match(/Lymph[-\s]?vascular invasion\s*:\s*([^\.\n]+)/i)||[])[1] || null;
      const pni = (t.match(/Perineural invasion\s*:\s*([^\.\n]+)/i)||[])[1] || null;
      const tilsPct = numOrNull((t.match(/Tumor infiltrating lymphocytes\s*:\s*([\d.]+)\s*%/i)||[])[1]);

      const erBlock = (t.match(/Estrogen receptor[^:]*:\s*([^\n]+)/i)||[])[1] || null;
      const prBlock = (t.match(/Progesterone receptor[^:]*:\s*([^\n]+)/i)||[])[1] || null;
      const her2Block = (t.match(/HER2[^:]*:\s*([^\n]+)/i)||[])[1] || null;
      const kiMatch = t.match(/Ki[-–]?\s*67[^:]*:\s*(\d{1,3})\s*%/i);

      const er = erBlock ? parseIHC(erBlock) : null;
      const pr = prBlock ? parseIHC(prBlock) : null;
      const her2 = her2Block ? parseIHC(her2Block) : null;
      const ki67 = kiMatch ? parseInt(kiMatch[1],10) : null;

      return { side, organ, histType, grade, gradeScore, tumorSizeMM:sizeMM, dcis, lvi, pni, tilsPct, er, pr, her2, ki67 };
    }

    function inferSubtype(p, threshold){
      const erPos = p.er && p.er.status==='positive';
      const prPos = p.pr && p.pr.status==='positive';
      const hrPos = !!(erPos || prPos);
      const her2Pos = (/(^|\b)(3\+|positive)($|\b)/i.test(p.her2?.score||"")) || (p.her2?.status==='positive');
      const hasKi = typeof p.ki67 === 'number';

      if(hrPos && !her2Pos && hasKi){
        return p.ki67 < threshold ? 'luminal type A' : 'luminal type B (HER2−)';
      }
      if(hrPos && her2Pos) return 'luminal type B (HER2+)';
      if(!hrPos && her2Pos) return 'HER2-enriched';
      if(!hrPos && !her2Pos) return 'triple-negative (basal-like)';
      return '—';
    }

    function buildSummary(p, threshold){
      const sideCap = p.side ? p.side.charAt(0).toUpperCase()+p.side.slice(1) : '';
      const typeStr = p.histType || 'invasive carcinoma';
      const gradeStr = p.grade ? `grade ${p.grade}` : 'grade ?';
      const sizeStr = p.tumorSizeMM!=null ? `, invasive size ${p.tumorSizeMM} mm` : '';

      const erStr = p.er ? `ER (estrogen receptor): ${p.er.status||'?'}${p.er.percent!=null?` (${p.er.percent}%)`:''}` : 'ER: ?';
      const prStr = p.pr ? `PR (progesterone receptor): ${p.pr.status||'?'}${p.pr.percent!=null?` (${p.pr.percent}%)`:''}` : 'PR: ?';
      const her2Str = p.her2 ? `HER2 (human epidermal growth factor receptor 2): ${p.her2.status||'?'}${p.her2.score?` (${p.her2.score})`:''}` : 'HER2: ?';
      const subtype = inferSubtype(p, threshold);

      const line = `${sideCap} breast ${typeStr}, ${gradeStr}${sizeStr}, ${erStr}, ${prStr}, ${her2Str}, ${subtype}, TxNxMx, Stage —`;
      return line.replace(/\s+,/g, ',');
    }

    function renderTable(p, threshold){
      const rows = [
        ['Side', p.side||'—'],
        ['Organ', p.organ||'—'],
        ['Histologic type', p.histType||'—'],
        ['Grade (Nottingham)', p.grade!=null? `${p.grade} (score ${p.gradeScore??'?'})` : '—'],
        ['Invasive size', p.tumorSizeMM!=null? `${p.tumorSizeMM} mm` : '—'],
        ['DCIS', p.dcis? `${p.dcis.present===true?'present':(p.dcis.present===false?'absent':'—')}${p.dcis.grade? ', nuclear grade '+p.dcis.grade:''}` : '—'],
        ['LVI', p.lvi||'—'],
        ['PNI', p.pni||'—'],
        ['TILs', p.tilsPct!=null? `${p.tilsPct}%` : '—'],
        ['ER', p.er? `${p.er.status??'?'}${p.er.percent!=null?` (${p.er.percent}%)`:''}${p.er.strength?`, ${p.er.strength}`:''}` : '—'],
        ['PR', p.pr? `${p.pr.status??'?'}${p.pr.percent!=null?` (${p.pr.percent}%)`:''}${p.pr.strength?`, ${p.pr.strength}`:''}` : '—'],
        ['HER2', p.her2? `${p.her2.status??'?'}${p.her2.score?` (${p.her2.score})`:''}${p.her2.percent!=null?`, ${p.her2.percent}%`:''}` : '—'],
        ['Ki‑67', p.ki67!=null? `${p.ki67}%` : '—'],
        ['Subtype (rule‑based)', inferSubtype(p, threshold)],
      ];
      const tbl = $('parsedTable');
      tbl.innerHTML = rows.map(([k,v])=>`<tr><td class="key">${k}</td><td>${v}</td></tr>`).join('');
      $('tableWrap').style.display='block';
    }

    function fillSample(){
      $('input').value = `Pathologic Diagnosis:\n Breast, right, core biopsy, invasive carcinoma of no special type, grade 1.\nGross Examination:\nThe specimen consists of six tissue fragments measuring up to 1.2 x 0.2 x 0.1 cm in size with grayish\nwhite cut surfaces. Entire specimen is embedded.\nMicroscopic Examination:\n • Histologic type: invasive carcinoma of no special type.\n • Tumor size of invasive component: 4 mm in greatest diameter.\n • Histologic grade (Nottingham histologic score): grade 1 (score 5).\n   ■ Glandular (acinar)/tubular differentiation: score 2.\n   ■ Nuclear pleomorphism: score 2.\n   ■ Mitotic rate: score 1.\n • Ductal carcinoma in situ: present, nuclear grade 2.\n • Lymph-vascular invasion: not identified.\n • Perineural invasion: not identified.\n • Tumor infiltrating lymphocytes: 5 %.\n • Results of immunohistochemical study:\n   ■ Estrogen receptor (Ab: Roche, clone SP1): positive ( 90 %, strong ).\n     (Internal control: positive )\n   ■ Progesterone receptor (Ab: Leica, clone 16): positive ( 95 %, strong ).\n    (Internal control: positive )\n   ■ HER2 (Ab: VENTANA, clone 4B5): negative (score 0, 0%).\n   ■ Ki-67 proliferative index (Ab: Dako, clone MIB-1): 10 %`;
    }

    $('sampleBtn').addEventListener('click', fillSample);

    $('parseBtn').addEventListener('click', ()=>{
      $('err').textContent=''; $('copiedMsg').style.display='none';
      try{
        const threshold = Math.max(0, Math.min(100, Number($('kiThresh').value)||20));
        const parsed = parseReport($('input').value);
        const line = buildSummary(parsed, threshold);
        $('summary').value = line; $('copyBtn').disabled = !line;
        renderTable(parsed, threshold);
      }catch(e){
        console.error(e); $('err').textContent='Failed to parse. Please check the input format.';
      }
    });

    $('copyBtn').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText($('summary').value); $('copiedMsg').style.display='inline'; setTimeout(()=>$('copiedMsg').style.display='none', 1200);}catch(e){}
    });
  </script>
</body>
</html>
